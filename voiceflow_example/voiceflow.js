var h=class{lang="en-US";continuous=!0;interimResults=!0;maxAlternatives=1;grammars=null;onstart=null;onaudioend=null;onspeechstart=null;onspeechend=null;onresult=null;onerror=null;onend=null;oninfo=null;ontranslation=null;voiceFlow={};ws;cleanup;started=!1;url;reconnectAttempts=0;maxReconnectAttempts=3;speechActive=!1;constructor(e,t){this.url=e,t&&Object.assign(this.voiceFlow,t)}async start(){if(this.started){console.warn("Speech recognition already started");return}this.ws&&this.ws.close(),this.started=!0;let e=this.voiceFlow.url||this.url,t=this.voiceFlow.token;try{let n=t?["bearer",t]:void 0;this.ws=new WebSocket(e,n),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{this.reconnectAttempts=0,this.handleOpen()},this.ws.onmessage=s=>this.handleMessage(s),this.ws.onerror=s=>{console.error("WebSocket error:",s),this.emitError("network",s.message||"ws_error")},this.ws.onclose=s=>{if(s.code===1008){this.emitError("auth","Authentication failed: "+(s.reason||"Invalid token")),this.finish("end");return}if(s.code!==1e3&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++,console.log(`WebSocket closed with code ${s.code}, attempting reconnect ${this.reconnectAttempts}/${this.maxReconnectAttempts}`),setTimeout(()=>{this.started&&this.start()},1e3*this.reconnectAttempts);return}this.finish("end")}}catch(n){console.error("Failed to create WebSocket:",n),this.started=!1,this.emitError("network","Failed to create WebSocket connection")}}stop(){try{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"stop"}))}catch{}this.finish("stop")}abort(){this.finish("abort")}enableTranslation(e){this.voiceFlow.translation={enabled:!0,...e},this.ws&&this.ws.readyState===WebSocket.OPEN&&this.sendTranslationConfig()}disableTranslation(){this.voiceFlow.translation&&(this.voiceFlow.translation.enabled=!1,this.ws&&this.ws.readyState===WebSocket.OPEN&&this.sendTranslationConfig())}setTranslationPrompt(e){this.voiceFlow.translation&&(this.voiceFlow.translation.prompt=e,this.ws&&this.ws.readyState===WebSocket.OPEN&&this.sendTranslationConfig())}setGeminiConfig(e){this.voiceFlow.translation&&(this.voiceFlow.translation.geminiConfig=e,this.ws&&this.ws.readyState===WebSocket.OPEN&&this.sendTranslationConfig())}sendTranslationConfig(){if(this.voiceFlow.translation)try{let e={type:"start",translationEnabled:this.voiceFlow.translation.enabled,translationPrompt:this.voiceFlow.translation.prompt,targetLanguage:this.voiceFlow.translation.targetLanguage,sourceLanguage:this.voiceFlow.translation.sourceLanguage,geminiModelConfig:this.voiceFlow.translation.geminiConfig};this.ws.send(JSON.stringify(e))}catch(e){console.error("Failed to send translation config:",e)}}async handleOpen(){try{await new Promise(n=>setTimeout(n,100));let e=this.voiceFlow.captureMode??"auto";e==="PCM16"||e==="auto"&&"audioWorklet"in AudioContext.prototype?await this.startPCM():await this.startOpus(),this.onstart?.(new Event("start"))}catch(e){console.error("Error in handleOpen:",e),this.emitError("initialization","Failed to initialize audio capture")}}sendStart(e){try{if(!this.ws||this.ws.readyState!==WebSocket.OPEN){if(this.ws&&this.ws.readyState===WebSocket.CONNECTING){let n=()=>{this.ws&&this.ws.readyState===WebSocket.OPEN?this.sendStart(e):this.ws&&this.ws.readyState===WebSocket.CONNECTING?setTimeout(n,50):this.emitError("communication","WebSocket connection failed to establish")};setTimeout(n,50);return}this.emitError("communication","WebSocket connection not ready");return}let t={type:"start",mode:e.mode,languageCode:this.lang,interimResults:this.interimResults,singleUtterance:this.voiceFlow.endpointing?.singleUtterance??!1,maxAlternatives:this.maxAlternatives,model:this.voiceFlow.model,useEnhanced:this.voiceFlow.useEnhanced,wordTimeOffsets:this.voiceFlow.wordTimeOffsets,enableWordConfidence:this.voiceFlow.enableWordConfidence,profanityFilter:this.voiceFlow.profanityFilter,spokenPunctuation:this.voiceFlow.spokenPunctuation,spokenEmojis:this.voiceFlow.spokenEmojis,phraseHints:this.voiceFlow.phraseHints,diarization:this.voiceFlow.diarization,audioChannelCount:this.voiceFlow.audioChannelCount,enableSeparateRecognitionPerChannel:this.voiceFlow.enableSeparateRecognitionPerChannel,alternativeLanguageCodes:this.voiceFlow.alternativeLanguageCodes,metadata:this.voiceFlow.metadata,adaptation:this.voiceFlow.adaptation,transcriptNormalization:this.voiceFlow.transcriptNormalization,translationEnabled:this.voiceFlow.translation?.enabled,translationPrompt:this.voiceFlow.translation?.prompt,targetLanguage:this.voiceFlow.translation?.targetLanguage,sourceLanguage:this.voiceFlow.translation?.sourceLanguage,geminiModelConfig:this.voiceFlow.translation?.geminiConfig,...this.voiceFlow.extraConfig,...e};this.ws.send(JSON.stringify(t))}catch{this.emitError("communication","Failed to send start message")}}async startPCM(){let e=this.voiceFlow.frameMs??10,t=this.voiceFlow.targetHz??16e3,n=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,noiseSuppression:!0,echoCancellation:!0,sampleRate:t}}),s=new AudioContext({latencyHint:"interactive"}),l=`
class PCMWorklet extends AudioWorkletProcessor {
  constructor(){ super(); this.buf=[]; this.frameSamples=0; this.target=16000;
    this.port.onmessage = e => { const {frameMs=20,targetHz=16000}=e.data||{}; this.frameSamples=Math.max(1, Math.round(frameMs*sampleRate/1000)); this.target=targetHz; };
  }
  downsample(x,inHz,outHz){ if(inHz===outHz) return x; const r=inHz/outHz, L=Math.floor(x.length/r), y=new Float32Array(L); let p=0; for(let i=0;i<L;i++){ y[i]=x[Math.floor(p)]||0; p+=r; } return y; }
  to16(f){ const b=new ArrayBuffer(f.length*2), v=new DataView(b); let o=0; for(let i=0;i<f.length;i++,o+=2){ let s=Math.max(-1,Math.min(1,f[i])); v.setInt16(o, s<0?s*0x8000:s*0x7fff, true);} return b; }
  process(inputs){ const c=inputs[0]?.[0]; if(!c) return true; this.buf.push(...c);
    while(this.buf.length>=this.frameSamples){ const frame=this.buf.splice(0,this.frameSamples);
      const ds=this.downsample(Float32Array.from(frame), sampleRate, this.target);
      const pcm=this.to16(ds); this.port.postMessage(pcm, [pcm]); }
    return true; }
}
registerProcessor("pcm-worklet", PCMWorklet);
`;await s.audioWorklet.addModule(URL.createObjectURL(new Blob([l],{type:"text/javascript"})));let c=s.createMediaStreamSource(n),a=new AudioWorkletNode(s,"pcm-worklet");a.port.postMessage({frameMs:e,targetHz:t}),c.connect(a),this.cleanup=()=>{try{a.disconnect(),c.disconnect(),s.close()}catch{}n.getTracks().forEach(i=>i.stop())},this.sendStart({mode:"PCM16",sampleRateHz:t}),a.port.onmessage=i=>{let o=i.data;if(this.ws&&this.ws.readyState===WebSocket.OPEN)try{this.ws.send(o)}catch{}}}async startOpus(){let e=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,noiseSuppression:!0,echoCancellation:!0,sampleRate:48e3}}),t=new MediaRecorder(e,{mimeType:"audio/webm;codecs=opus",audioBitsPerSecond:32e3});this.cleanup=()=>{try{t.stop()}catch{}e.getTracks().forEach(n=>n.stop())},this.sendStart({mode:"WEBM_OPUS"}),t.start(10),t.ondataavailable=n=>{if(n.data.size>0&&this.ws&&this.ws.readyState===WebSocket.OPEN)try{this.ws.send(n.data)}catch{}}}handleMessage(e){let t=JSON.parse(e.data);if(t.type==="error"){this.emitError("service",t.err||"unknown_error");return}if(t.type==="info"||t.type==="ready"||t.type==="stopped"){if(this.oninfo){let i=new Event("info");i.data=t,i.messageType=t.type,i.info=t,this.oninfo(i)}return}if(t.type==="translation"){if(this.ontranslation){let i=t,o=new Event("translation");o.original=i.original,o.translated=i.translated,o.sourceLanguage=i.sourceLanguage,o.targetLanguage=i.targetLanguage,o.translationId=i.translationId,o.timestamp=i.timestamp,this.ontranslation(o)}return}if(t.type!=="transcript")return;let n=t,s={transcript:n.transcript,confidence:n.confidence},l=d([s],n.isFinal),c=u([l]),a=new Event("result");a.results=c,a.resultIndex=c.length-1,a.stability=n.stability,a.segment=n.segment,a.streamId=n.streamId,a.adjustedTime=n.adjustedTime,a.bridgingOffset=n.bridgingOffset,this.onresult?.(a),!this.speechActive&&n.transcript&&n.transcript.trim()&&(this.speechActive=!0,this.onspeechstart&&this.onspeechstart(new Event("speechstart"))),this.speechActive&&n.isFinal&&(this.speechActive=!1,this.onspeechend&&this.onspeechend(new Event("speechend")))}emitError(e,t){let n=new Event("error");n.error=e,n.message=t,this.onerror?.(n)}finish(e){try{this.ws?.close()}catch{}try{this.cleanup?.()}catch{}this.started=!1,this.speechActive=!1,this.onaudioend?.(new Event("audioend")),this.onend?.(new Event("end"))}};function d(r,e){let t=r.map(({transcript:n,confidence:s})=>({transcript:n,confidence:s}));return t.isFinal=e,t.length=r.length,t.item=n=>t[n],t}function u(r){let e=r.slice();return e.length=r.length,e.item=t=>e[t],e}export{h as VoiceFlowRecognition};
